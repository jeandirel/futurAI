<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>OneClickQuiz Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --accent: #38bdf8;
      --muted: #94a3b8;
      --border: #1f2937;
    }
    body { margin:0; font-family: "Segoe UI", sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 16px 24px; border-bottom: 1px solid var(--border); display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size: 20px; }
    main { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; padding: 16px; }
    section { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom:4px; }
    input, select { width:100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: #0b1120; color: var(--text); margin-bottom:8px; }
    button { background: var(--accent); color:#0b1120; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .row { display:flex; gap: 8px; align-items: center; }
    .table { width:100%; border-collapse: collapse; margin-top:8px; }
    .table th, .table td { padding: 8px; border-bottom:1px solid var(--border); font-size: 13px; text-align:left; }
    .badge { padding: 2px 8px; border-radius:12px; font-size: 11px; }
    .status-completed { background:#10b981; color:#022c22; }
    .status-failed { background:#f87171; color:#2d0a0a; }
    .status-pending { background:#facc15; color:#2c2506; }
    .status-running { background:#38bdf8; color:#082f49; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0b1120; padding:8px; border-radius:6px; }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>OneClickQuiz Dashboard</h1>
    <span class="muted">API: http://127.0.0.1:8000</span>
  </header>
  <main>
    <section>
      <h2>Créer un job</h2>
      <div class="row">
        <div style="flex:1">
          <label>Sujet</label>
          <input id="subject" value="La photosynthèse" />
        </div>
        <div style="flex:1">
          <label>Niveau / cours</label>
          <input id="level" value="Terminale" />
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Langue</label>
          <select id="language">
            <option value="fr">fr</option>
            <option value="en">en</option>
          </select>
        </div>
        <div style="width:120px">
          <label>Nombre</label>
          <input id="count" type="number" min="1" max="10" value="1" />
        </div>
      </div>
      <button id="createBtn">Générer</button>
      <div id="createStatus" class="muted"></div>
    </section>

    <section>
      <h2>Métriques</h2>
      <div id="metrics" class="muted">Chargement...</div>
      <button id="refreshMetrics" style="margin-top:8px;">Rafraîchir</button>
      <div style="margin-top:12px;">
        <a href="http://127.0.0.1:8000/metrics/prom" target="_blank" style="color:var(--accent); font-size:12px;">/metrics/prom</a>
      </div>
    </section>

    <section style="grid-column: span 2">
      <div class="row" style="justify-content: space-between;">
        <h2>Jobs</h2>
        <div class="row">
          <label class="muted">Filtre statut</label>
          <select id="filterStatus">
            <option value="">(tous)</option>
            <option value="completed">completed</option>
            <option value="failed">failed</option>
            <option value="pending">pending</option>
            <option value="running">running</option>
          </select>
          <button id="refreshJobs">Rafraîchir</button>
        </div>
      </div>
      <table class="table" id="jobsTable">
        <thead>
          <tr>
            <th>ID</th><th>Sujet</th><th>Niveau</th><th>Langue</th><th>Status</th><th>Count</th><th>Créé</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="jobDetail"></div>
    </section>
  </main>

  <script>
    const apiBase = "http://127.0.0.1:8000";

    function badge(status) {
      const cls = {
        completed: "status-completed",
        failed: "status-failed",
        pending: "status-pending",
        running: "status-running"
      }[status] || "status-pending";
      return `<span class="badge ${cls}">${status}</span>`;
    }

    async function createJob() {
      const btn = document.getElementById("createBtn");
      const statusEl = document.getElementById("createStatus");
      btn.disabled = true;
      statusEl.textContent = "Génération en cours...";
      try {
        const payload = {
          subject: document.getElementById("subject").value,
          level: document.getElementById("level").value,
          language: document.getElementById("language").value,
          count: parseInt(document.getElementById("count").value || "1", 10)
        };
        const res = await fetch(`${apiBase}/jobs/generate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        statusEl.textContent = `Job ${data.job.job_id} créé (${data.job.status})`;
        loadJobs();
      } catch (e) {
        statusEl.textContent = "Erreur: " + e;
      } finally {
        btn.disabled = false;
      }
    }

    async function loadJobs() {
      const status = document.getElementById("filterStatus").value;
      const url = status ? `${apiBase}/jobs?status=${status}` : `${apiBase}/jobs`;
      const res = await fetch(url);
      const data = await res.json();
      const tbody = document.querySelector("#jobsTable tbody");
      tbody.innerHTML = data.map(j => `
        <tr>
          <td>${j.job_id.slice(0,8)}…</td>
          <td>${j.subject}</td>
          <td>${j.level}</td>
          <td>${j.language}</td>
          <td>${badge(j.status)}</td>
          <td>${j.count}</td>
          <td>${j.created_at || ""}</td>
          <td><button onclick="loadJobDetail('${j.job_id}')">Détail</button></td>
        </tr>
      `).join("");
    }

    async function loadJobDetail(id) {
      const res = await fetch(`${apiBase}/jobs/${id}`);
      if (!res.ok) {
        document.getElementById("jobDetail").innerHTML = `<div class="muted">Job introuvable</div>`;
        return;
      }
      const job = await res.json();
      const items = job.items || [];
      const mcqHtml = items.map((m, idx) => `
        <div style="border:1px solid var(--border); border-radius:6px; padding:8px; margin-top:8px;">
          <div class="muted">Q${idx+1}</div>
          <pre>${m.question}</pre>
          <ul>${m.options.map(o => `<li>${o}${o===m.answer ? " ✔" : ""}</li>`).join("")}</ul>
          <div class="muted">${m.bloom} · ${m.solo} · ${m.difficulty}</div>
        </div>
      `).join("");
      const exportLink = `${apiBase}/jobs/${id}/export?format=csv`;
      document.getElementById("jobDetail").innerHTML = `
        <h3>Détail job ${id}</h3>
        <div class="muted">${job.subject} · ${job.level} · ${badge(job.status)}</div>
        <div style="margin-top:8px;"><a href="${exportLink}" target="_blank" style="color:var(--accent);">Exporter CSV</a></div>
        ${mcqHtml || "<div class='muted'>Aucun MCQ</div>"}
      `;
    }

    async function loadMetrics() {
      const res = await fetch(`${apiBase}/metrics`);
      const data = await res.json();
      const m = data;
      const jobs = m.jobs || {};
      const mcq = m.mcq || {};
      document.getElementById("metrics").innerHTML = `
        <div>Jobs : ${jobs.total || 0} (✅ ${jobs.completed || 0} · ❌ ${jobs.failed || 0} · ⏳ ${jobs.pending || 0})</div>
        <div>MCQ total : ${mcq.total || 0} · moyenne/job : ${jobs.avg_mcq_per_job?.toFixed ? jobs.avg_mcq_per_job.toFixed(2) : "–"}</div>
        <div>Dernier job : ${jobs.latest_created_at || "–"}</div>
      `;
    }

    document.getElementById("createBtn").onclick = createJob;
    document.getElementById("refreshJobs").onclick = loadJobs;
    document.getElementById("refreshMetrics").onclick = loadMetrics;
    document.getElementById("filterStatus").onchange = loadJobs;

    loadJobs();
    loadMetrics();
  </script>
</body>
</html>
